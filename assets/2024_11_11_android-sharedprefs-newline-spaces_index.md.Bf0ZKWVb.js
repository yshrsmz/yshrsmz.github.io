import{_ as i,o as a,a as n,X as e}from"./chunks/framework.BPPv2K3c.js";const o=JSON.parse('{"title":"SharedPreferences に末尾が改行になる文字列を保存するとよくわからんスペースが4つ追加される件","description":"","frontmatter":{"layout":"post","title":"SharedPreferences に末尾が改行になる文字列を保存するとよくわからんスペースが4つ追加される件","tags":["TIL","Android"],"head":[["link",{"rel":"canonical","href":"https://www.codingfeline.com/2024/11/11/android-sharedprefs-newline-spaces/"}],["meta",{"property":"og:url","content":"https://www.codingfeline.com/2024/11/11/android-sharedprefs-newline-spaces/"}],["meta",{"property":"og:title","content":"SharedPreferences に末尾が改行になる文字列を保存するとよくわからんスペースが4つ追加される件"}],["meta",{"property":"twitter:card","content":"summary_large_image"}],["meta",{"property":"twitter:site","content":"@_yshrsmz"}],["meta",{"property":"twitter:creator","content":"@_yshrsmz"}],["meta",{"property":"og:image","content":"https://www.codingfeline.com/2024/11/11/android-sharedprefs-newline-spaces/ogp.png"}]]},"headers":[],"relativePath":"2024/11/11/android-sharedprefs-newline-spaces/index.md","filePath":"posts/2024/2024-11-11-android-sharedprefs-newline-spaces.md","date":{"time":"2024-11-11","string":"November 11, 2024","year":"2024","month":"11","day":"11"}}'),t={name:"2024/11/11/android-sharedprefs-newline-spaces/index.md"};function h(l,s,p,k,r,d){return a(),n("div",null,[...s[0]||(s[0]=[e(`<p>なぜか4つスペースが追加されたしばらく悩んだ</p><p><strong>目次</strong></p><nav class="table-of-contents"><ul><li><a href="#tl-dr">TL;DR</a></li><li><a href="#くわしく">くわしく</a><ul><li><a href="#事象">事象</a></li><li><a href="#google-の-issue-tracker-にあった">Google の Issue Tracker にあった</a></li><li><a href="#解決策">解決策</a></li></ul></li><li><a href="#なんで今さら">なんで今さら</a></li></ul></nav><h2 id="tl-dr" tabindex="-1">TL;DR <a class="header-anchor" href="#tl-dr" aria-label="Permalink to &quot;TL;DR&quot;">​</a></h2><p>Android の仕様なので致し方なし。保存時にマーカー追加して、取得時にマーカー削除するような workaround が必要。</p><h2 id="くわしく" tabindex="-1">くわしく <a class="header-anchor" href="#くわしく" aria-label="Permalink to &quot;くわしく&quot;">​</a></h2><h3 id="事象" tabindex="-1">事象 <a class="header-anchor" href="#事象" aria-label="Permalink to &quot;事象&quot;">​</a></h3><p>SharedPreferences に保存する文字列の末尾に改行が含まれると、半角スペース4つが追加される。</p><div class="language-kt vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">kt</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">prefs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">edit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">putString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;key&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;test</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apply</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>のような感じで保存すると、取得するときには <code>test\\n    </code> になってしまう。</p><p>コード的には上記のように保存していても、保存された xml には半角4文字が suffix された状態で格納されてしまう。</p><h3 id="google-の-issue-tracker-にあった" tabindex="-1">Google の Issue Tracker にあった <a class="header-anchor" href="#google-の-issue-tracker-にあった" aria-label="Permalink to &quot;Google の Issue Tracker にあった&quot;">​</a></h3><ul><li><a href="https://issuetracker.google.com/issues/37032278" target="_blank" rel="noreferrer">Strings with line feeds incorrectly restored from SharedPreferences. [37032278] - Issue Tracker</a></li></ul><p>SharedPreferences 周りの実装バグで、値の末尾に改行があると半角スペース4つが追加されてしまうらしい。値としての改行と、XML のインデントとしての改行が混同されているというかなんというか。</p><h3 id="解決策" tabindex="-1">解決策 <a class="header-anchor" href="#解決策" aria-label="Permalink to &quot;解決策&quot;">​</a></h3><p>これも前述の issue にあった。 この半角スペース追加処理は我々側ではどうしようもないので、値を <code>&quot;</code> で囲って保存し、取得時に <code>&quot;</code> を削除する、というものだ。</p><div class="language-kt vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">kt</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fun</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">wrapContent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(): </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // multiline string 使って \`&quot;\` をエスケープ、prefx, suffix に追加する</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;&quot;&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$this</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fun</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unwrapContent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(): </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 追加した \`&quot;\` を削除する</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">drop</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">drapLast</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fun</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  val</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;test</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  prefs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">edit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">putString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;key&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">wrapContent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apply</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  val</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> saved </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prefs</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;key&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;DEFAULT_VALUE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">wrapContent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unwrapContent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  val</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> same </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> saved</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>ただこれ、単純に末尾に <code>$</code> とか、なにかマーカーとして扱える文字を保存時に追加→取得時に削除、で問題ない気もする。</p><p>しかしメンテ中アプリの場合、単純にこの実装してしまうとすでに保存されてる値の前後1文字ずつが削除されてしまうので注意が必要。私は注意してなかったのでやってしまいました。</p><h2 id="なんで今さら" tabindex="-1">なんで今さら <a class="header-anchor" href="#なんで今さら" aria-label="Permalink to &quot;なんで今さら&quot;">​</a></h2><p>もう10年近く運用してるアプリでなんで今さらこんな仕様バグみたいなの踏むの、って思ったら今年の夏まで SharedPreferences 使ってなかったからだった。それまでは Tray という SharedPreferences 互換の別ライブラリを使っていたんだけど、いい加減メンテされてなくて jCenter クローズとともに闇に消えたので、夏の minSdk 更新といっしょに大急ぎで SharedPreferences に移行したんでした。</p>`,21)])])}const g=i(t,[["render",h]]);export{o as __pageData,g as default};
