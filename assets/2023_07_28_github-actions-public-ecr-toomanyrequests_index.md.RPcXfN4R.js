import{_ as t,a,o as i,X as s}from"./chunks/framework.Cp7KI1mb.js";const d=JSON.parse('{"title":"Public ECR を GitHub Actions から使ったときの toomanyrequests について","description":"","frontmatter":{"layout":"post","title":"Public ECR を GitHub Actions から使ったときの toomanyrequests について","category":"programming","tags":["TIL","GitHub Actions","AWS"],"head":[["link",{"rel":"canonical","href":"https://www.codingfeline.com/2023/07/28/github-actions-public-ecr-toomanyrequests/"}],["meta",{"property":"og:url","content":"https://www.codingfeline.com/2023/07/28/github-actions-public-ecr-toomanyrequests/"}],["meta",{"property":"og:title","content":"Public ECR を GitHub Actions から使ったときの toomanyrequests について"}],["meta",{"property":"twitter:card","content":"summary_large_image"}],["meta",{"property":"twitter:site","content":"@_yshrsmz"}],["meta",{"property":"twitter:creator","content":"@_yshrsmz"}],["meta",{"property":"og:image","content":"https://www.codingfeline.com/2023/07/28/github-actions-public-ecr-toomanyrequests/ogp.png"}]]},"headers":[],"relativePath":"2023/07/28/github-actions-public-ecr-toomanyrequests/index.md","filePath":"posts/2023/2023-07-28-github-actions-public-ecr-toomanyrequests.md","date":{"time":"2023-07-28","string":"July 28, 2023","year":"2023","month":"07","day":"28"}}'),n={name:"2023/07/28/github-actions-public-ecr-toomanyrequests/index.md"};function r(o,e,l,c,u,p){return i(),a("div",null,[...e[0]||(e[0]=[s(`<p>最近仕事で AWS CodeBuild で動いていたコンテナイメージのビルドジョブを、GitHub Actions に移行している。</p><p>だいたいビルドは通るのだけど、たまに下記のようなエラーで失敗することがある</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Step</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 4/33</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> FROM</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> public.ecr.aws/docker/library/node:18.16</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> AS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build-stage</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">18.16:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Pulling</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker/library/node</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toomanyrequests:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Rate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exceeded</span></span></code></pre></div><p>まあ見ての通り、 Public ECR 上の node イメージを pull しようとして Rate Limit に引っかかっている。</p><p>しかし、 Public ECR は DockerHub がイメージの pull に制限をかけたことをきっかけに生まれたとものなので、基本無制限のハズでは？　と思っていた。</p><p>ところがよくよく調べてみると、 pull が無制限なのは &quot;AWS 上で動いているものから使う時のみ&quot; だったようだ。</p><p>AWS の <a href="https://aws.amazon.com/blogs/aws/amazon-ecr-public-a-new-public-container-registry/" target="_blank" rel="noreferrer">Public ECR ローンチ時のブログ記事</a>にはこのように書かれている</p><blockquote><p>Anyone who pulls images anonymously will get 500 GB of free data bandwidth each month, after which they can sign up or sign in to an AWS account to get more. Simply authenticating with an AWS account increases free data bandwidth up to 5 TB each month when pulling images from the internet.</p><p>Finally, workloads running in AWS will get unlimited data bandwidth from any region when pulling publicly shared images from ECR Public.</p></blockquote><p>また、<a href="https://docs.aws.amazon.com/AmazonECR/latest/public/public-service-quotas.html" target="_blank" rel="noreferrer">Public ECR の service quota</a>にも、下記のような記載がある</p><ul><li>Rate of authenticated image pulls: Each supported Region: 10 per second</li><li>Rate of unauthenticated image pulls: Each supported Region: 1 per second</li></ul><p>未認証の場合だと pull は1秒に1回なので、そりゃタイミングによってはエラーになるなあ、という感じ。</p><h2 id="解決策" tabindex="-1">解決策 <a class="header-anchor" href="#解決策" aria-label="Permalink to &quot;解決策&quot;">​</a></h2><h3 id="_1-docker-hub-のイメージを使う" tabindex="-1">1. Docker Hub のイメージを使う <a class="header-anchor" href="#_1-docker-hub-のイメージを使う" aria-label="Permalink to &quot;1. Docker Hub のイメージを使う&quot;">​</a></h3><p>どうやら GitHub Actions の GitHub-hosted Runner から利用するぶんには、DockerHub の Rate Limit には引っかからないらしい、というのを <a href="https://github.com/actions/runner-images/issues/1445#issuecomment-713861495" target="_blank" rel="noreferrer">GitHub の issue で見つけた</a>(ただし Public なイメージに限る)。なので今回はこちらの方法を採用。</p><p>しかし self-hosted runner を使う場合は DockerHub の制限に引っかかるのでまた対策が必要。</p><h3 id="_2-authenticated-user-として-pull-する。" tabindex="-1">2. authenticated user として pull する。 <a class="header-anchor" href="#_2-authenticated-user-として-pull-する。" aria-label="Permalink to &quot;2. authenticated user として pull する。&quot;">​</a></h3><p>DockerHub のイメージを使うことにしたから試してないが、前述の記事やドキュメントを見る限りだと、AWS ユーザとして認証したら Rate Limit がかなり緩和されるはず。</p><h2 id="参考" tabindex="-1">参考 <a class="header-anchor" href="#参考" aria-label="Permalink to &quot;参考&quot;">​</a></h2><ul><li><a href="https://aws.amazon.com/blogs/aws/amazon-ecr-public-a-new-public-container-registry/" target="_blank" rel="noreferrer">Amazon Elastic Container Registry Public: A New Public Container Registry - AWS News Blog</a></li><li><a href="https://docs.aws.amazon.com/AmazonECR/latest/public/public-service-quotas.html" target="_blank" rel="noreferrer">Amazon ECR Public service quotas - Amazon ECR Public</a></li><li><a href="https://github.com/actions/runner-images/issues/1445#issuecomment-713861495" target="_blank" rel="noreferrer">Did Dockerhub rate limit affect Github Action? · Issue #1445 · actions/runner-images</a></li></ul>`,19)])])}const m=t(n,[["render",r]]);export{d as __pageData,m as default};
